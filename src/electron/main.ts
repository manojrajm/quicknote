// Copyright (c) 2022 Sri Lakshmi Kanthan P
// 
// This software is released under the MIT License.
// https://opensource.org/licenses/MIT


import { Menu, MenuItem, app } from 'electron';
import settings from 'electron-settings';
import { menubar, Menubar } from 'menubar';
import * as c from './constants';
import { installDevTools } from './utilities';


// This allows TypeScript to pick up the magic constants that's auto-generated by Forge's Webpack
// plugin that tells the Electron app where to look for the Webpack-bundled app code (depending on
// whether you're running in development or production).


// Main Window Preload Entry
declare const NOTE_WINDOW_PRELOAD_WEBPACK_ENTRY: string;

// Main Window Load entry
declare const NOTE_WINDOW_WEBPACK_ENTRY: string;


// stop your app launching at install
if (require('electron-squirrel-startup')) {
  app.quit();
}

// get the lock to chen single instance
if (!app.requestSingleInstanceLock()) {
  app.quit();
}

// Add app to system startup
app.setLoginItemSettings({
  openAtLogin: app.isPackaged,
  openAsHidden: true,
  path: app.getPath("exe")
});

// Main Window is created on mb.app.on('ready')
const mb: Menubar = menubar({
  index: NOTE_WINDOW_WEBPACK_ENTRY,
  tooltip: c.APPLICATION_NAME,
  icon: c.APPLICATION_ICON,
  browserWindow: {
    icon: c.APPLICATION_ICON,
    frame: false,
    show: false,
    skipTaskbar: true,
    resizable: true,
    webPreferences: {
      preload: NOTE_WINDOW_PRELOAD_WEBPACK_ENTRY,
      devTools: !app.isPackaged
    }
  }
});

// on ready event
mb.on('ready', () => mb.on('after-create-window', async () => {
  // set the context menu for the tray
  mb.tray.setContextMenu(Menu.buildFromTemplate([
    { label: 'About', click: () => open(c.APPLICATION_URL) },
    { label: 'Issue', click: () => open(c.ISSUE_RAISE_URL) },
    { type: 'separator' },
    { label: 'Quit', click: () => app.quit() }
  ]));

  // size of the window
  const [width, height] = (await settings.has('window.size'))
    ? (await settings.get('window.size')) as [number, number]
    : c.APPLICATION_SIZE;

  // set the size
  mb.window.setSize(width, height);

  // on resized event save the size
  mb.window.on('resized', () => {
    settings.set('window.size', mb.window.getSize());
  });

  // install dev tools if not packaged
  if (!mb.app.isPackaged) {
    installDevTools();
  }

  // Create Non visible Menu 
  const menu = new Menu();

  // Add ESC to close the app
  menu.append(new MenuItem({
    label: 'Hide QuickNote',
    visible: false,
    accelerator: 'Esc',
    click: () => {
      mb.window.hide();
    }
  }));

  // Add for dev tools
  menu.append(new MenuItem({
    label: "Open Dev Tools",
    visible: false,
    accelerator: "Control+D",
    click: () => {
      mb.window.webContents.openDevTools();
    }
  }));

  // Add for Quit
  menu.append(new MenuItem({
    label: "Quit QuickNote",
    visible: false,
    accelerator: "Control+Q",
    click: () => {
      mb.app.quit();
    }
  }));

  // set the menu
  Menu.setApplicationMenu(menu);
}));
